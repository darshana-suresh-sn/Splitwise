<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope) {
	/* widget controller */
	var c = this;
	c.expenseObj = {};
	c.expenseObj.memberList = [];
	
	c.onSplitEqualChanged = function(){
		c.splitAmount();
	}
	c.splitAmount = function()
	{
		if(c.expenseObj.splitEqually && c.expenseObj.memberList) 
		{
			var splitAmount = c.expenseObj.amount/c.expenseObj.memberList.length;
			for(var i=0;i<c.expenseObj.memberList.length;++i)
				c.expenseObj.memberList[i].amount = splitAmount;
		}
		c.checkInputValidity();
	}
	c.onAmountChanged = function()
	{
		c.splitAmount();
	}
	c.onCancel = function()
	{
		c.clearFormValues();
	}
	c.checkInputValidity = function()
	{
		if(c.isSumValid() && c.expenseObj && c.expenseObj.paidBy && c.expenseObj.amount > 0 && c.expenseObj.expenseName)
			c.areInputsValid = true;
		else
			c.areInputsValid = false;
	}
	c.isSumValid = function()
	{
		if(!c.expenseObj.memberList) return;
		var sum = 0;
		for(var i=0;i<c.expenseObj.memberList.length;++i)
		{
			sum += c.expenseObj.memberList[i].amount;
		}
		if(sum!=c.expenseObj.amount)
		{
			var diff = c.expenseObj.amount - sum;
			c.expenseObj.errorMsg = "Amount of Rs."+diff +" left to adjust";
			return false;
		}
		else
		{
			c.expenseObj.errorMsg = "";
			return true;
		}	
	}
	c.clearFormValues = function(){
		c.expenseObj.paidBy = scope.user.sys_id;
		c.expenseObj.amount = 0;
		c.expenseObj.expenseName = '';
		c.expenseObj.splitEqually = true;
		c.areInputsValid = false;
		if(c.expenseObj.memberList)
		{
			for(var i=0;i<c.expenseObj.memberList.length;++i)
				c.expenseObj.memberList[i].amount = 0;
		}
		else
			c.expenseObj.memberList = [];
	}
	if($scope.options && $scope.options.shared)
	{	
		$scope.options.shared.result = c.expenseObj;
		if($scope.options.shared.action=="openExisting")
		{
			var widgetData = $scope.options.shared.selectedExpense;
			if(widgetData.expense_name)
				c.expenseObj.expenseName = widgetData.expense_name.value;
			if(widgetData.paid_by)
				c.expenseObj.paidBy = widgetData.paid_by.value;
			if(widgetData.total_amount)
				c.expenseObj.amount = widgetData.total_amount.value;
			c.expenseObj.group_id = $scope.options.shared.group_id;
			c.expenseObj.expense_id = widgetData.sys_id;

			console.log(JSON.stringify(widgetData));
			console.log(JSON.stringify(c.expenseObj));

			c.server.get({
				action:'getExpenseData',
				group_id:c.expenseObj.group_id,
				expense_id:c.expenseObj.expense_id
			}).then(function(result){
				console.log(JSON.stringify(result.data));
				c.expenseObj.memberList = result.data.memberList;
			});
		}
	else if($scope.options.shared.action=="createNew")
		{
			c.expenseObj.group_id = $scope.options.shared.group_id;
			c.clearFormValues();
			c.server.get({
				action:'getGroupMembers',
				group_id:c.expenseObj.group_id
			}).then(function(result){
				c.expenseObj.memberList = result.data.memberList;
			});
		}
	}
	else
		c.clearFormValues();
};]]></client_script>
        <controller_as>c</controller_as>
        <css>#parentBody
{
  margin:10px;
}
td,th{
  padding:5px;
}
table
{
  margin:15px 0px;
}
.checkboxStyle
{
  margin:0px 5px 0px 0px;
}
#addMemberbtn
{
  margin:0 0 0 5px;
}
.expenseInput,th
{
  width:200px;
  height:25px;
}
#addExpenseBtn{
  width:100%;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>add_expense</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Add expense</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */

	var getExpenseData = function(expense_id,group_id)
	{
		getGroupMembers(group_id);
		var memberAmounts = getExpenseDist(expense_id,group_id);
		if(data.memberList && memberAmounts)
		{
			data.count=0;
			for(var i=0;i<data.memberList.length;++i)
			{
				data.count++;
				if(memberAmounts[data.memberList[i].sys_id])
					data.memberList[i].amount = memberAmounts[data.memberList[i].sys_id].amount_owed;
				else
					data.memberList[i].amount = 0;
			}
		}
	}
	var getGroupMembers = function(group_id){
		data.memberList = [];
		var gr = new GlideRecord('sn_splitwise_group');
		gr.addQuery('sys_id',group_id);
		gr.query();
		data.memberDetails = {};
		if(gr.next())
		{
			$sp.getRecordValues(data.memberDetails, gr, 'sys_id,name,members');
		}

		gr = new GlideRecord('sys_user');
		gr.addQuery('sys_id','IN',data.memberDetails.members);
		gr.query();
		while(gr.next())
		{
			var memberDetails = {};
			$sp.getRecordDisplayValues(memberDetails, gr, 'sys_id,name');
			memberDetails.amount = 0;
			data.memberList.push(memberDetails);
		}
	};
	var getExpenseDist = function(expense_id,group_id)
	{
		var gr = new GlideRecord('sn_splitwise_expense_distribution');
		gr.addQuery('expense_id',expense_id);
		gr.addQuery('group_id',group_id);
		gr.query();
		var memberAmounts = {},resObj = {};
		while(gr.next())
		{
			$sp.getRecordValues(resObj, gr, 'member,amount_owed');
			memberAmounts[resObj.member] = resObj.amount_owed;
		}
		data.memberAmounts = memberAmounts;
		return memberAmounts;
	}
	if(input)
	{
		if(input.action=='getExpenseData')
		getExpenseData(input.expense_id,input.group_id);
		else if(input.action=='getGroupMembers')
			getGroupMembers(input.group_id);
	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-06-04 13:31:36</sys_created_on>
        <sys_id>7cc4681a7fe60210d94a0cd10d86654b</sys_id>
        <sys_mod_count>289</sys_mod_count>
        <sys_name>Add expense</sys_name>
        <sys_package display_value="Splitwise" source="sn_splitwise">a8747a317f220210d94a0cd10d86659d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Splitwise">a8747a317f220210d94a0cd10d86659d</sys_scope>
        <sys_update_name>sp_widget_7cc4681a7fe60210d94a0cd10d86654b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-06-12 18:19:56</sys_updated_on>
        <template><![CDATA[<div id="parentBody">
  <!-- your widget template
  <button id="addExpenseBtn" ng-click="c.onAddExpense()" ng-show="!c.showExpenseForm"
          class="btn btn-{{options.color}} m-b">
    Add New Expense
  </button>
  -->
  <div id="expenseForm">
    <form>
      <table id="expenseTable">
        <tr>
          <td>
            <label for="expenseName">Expense Name:</label>
          </td>
          <td>
            <input type="text" id="expenseName" 
                   ng-model="c.expenseObj.expenseName" ng-change="c.checkInputValidity()"
                   class="expenseInput"><br>
          </td>
        </tr>
        <tr>
          <td>
            <label for="paidBy">Paid by:</label>
          </td>
          <td>
            <select ng-model="c.expenseObj.paidBy" class="expenseInput"
                    ng-options='member.sys_id as member.name for member in c.expenseObj.memberList'>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            <label for="amount">Amount:</label>
          </td>
          <td>
            <input ng-model="c.expenseObj.amount" 
                   id="amount"
                   ng-change="c.onAmountChanged()"
                   class="expenseInput"><br>
          </td>
        </tr>
      </table>
      <table id="splittingTable">
        <tr>
          <td>
            <input type="checkbox" id="splitEqual" 
                   ng-model="c.expenseObj.splitEqually" ng-change="c.onSplitEqualChanged()"
                   class="checkboxStyle" ng-disabled="c.areMembersEmpty()">
            <label for="splitEqual" id="splitEqualLabel" class="checkboxLabelStyle">Split equally</label>
          </td>
        </tr>
        <tr>
          <th>Member name</th>
          <th>Amount</th>
        </tr>
        <tr ng-repeat="x in c.expenseObj.memberList">
          <td>{{x.name}}</td>
          <td>
            <input
                   ng-model="x.amount" 
                   ng-disabled="c.expenseObj.splitEqually"
                   ng-change="c.isSumValid()">
          </td>
        </tr>
      </table>

                       <font color="red" id="errorMsg">
        {{c.expenseObj.errorMsg}}
      </font>
      <br> 
      <input type="submit" ng-disabled="!c.areInputsValid">

      <button ng-click="c.onCancel()">
        Cancel
      </button>

    </form>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
