<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function() {
	/* widget controller */
	var c = this;
	var memberIdCounter = 1;
	c.showExpenseForm = false;
	c.expenseObj = {};
	c.memberList = c.data.memberList;

	c.onAddExpense = function()
	{
		c.showExpenseForm = true;
	}

	c.onSplitEqualChanged = function(){
		c.splitAmount();
	}
	c.splitAmount = function()
	{
		if(c.expenseObj.splitEqually && c.data.memberList) 
		{
			var splitAmount = c.expenseObj.amount/c.memberList.length;
			for(var i=0;i<c.memberList.length;++i)
				c.memberList[i].amount = splitAmount;
		}
		c.checkInputValidity();
	}
	c.onAmountChanged = function()
	{
		c.splitAmount();
	}
	c.onCancel = function()
	{
		c.showExpenseForm = false;
		c.clearFormValues();
	}
	c.checkInputValidity = function()
	{
		if(c.isSumValid() && c.expenseObj && c.expenseObj.paidBy && c.expenseObj.amount > 0 && c.expenseObj.expenseName)
			c.areInputsValid = true;
		else
			c.areInputsValid = false;
	}
	c.isSumValid = function()
	{
		if(!c.memberList) return;
		var sum = 0;
		for(var i=0;i<c.memberList.length;++i)
			{
				sum += c.memberList[i].amount;
			}
		if(sum!=c.expenseObj.amount)
			{
				var diff = c.expenseObj.amount - sum;
				c.expenseObj.errorMsg = "Amount of Rs."+diff +" left to adjust";
				return false;
			}
		else
		{
			c.expenseObj.errorMsg = "";
			return true;
		}	
	}
	c.clearFormValues = function(){
		c.expenseObj.paidBy = scope.user.sys_id;
		c.expenseObj.amount = 0;
		c.expenseObj.expenseName = '';
		c.expenseObj.splitEqually = true;
		c.expenseObj.groupName = 'Vacation';
		c.areInputsValid = false;
		if(c.memberList)
		{
			for(var i=0;i<c.memberList.length;++i)
				c.memberList[i].amount = 0;
		}
	}

	c.clearFormValues();
};]]></client_script>
        <controller_as>c</controller_as>
        <css>#parentBody
{
  margin:10px;
}
td,th{
  padding:5px;
}
table
{
  margin:15px 0px;
}
.checkboxStyle
{
  margin:0px 5px 0px 0px;
}
#addMemberbtn
{
  margin:0 0 0 5px;
}
.expenseInput,th
{
  width:200px;
  height:25px;
}
#addExpenseBtn{
  width:100%;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>add_expense</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Add expense</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	
	var getSplitUsers = function()
	{
			data.memberList = [];
			var userRecords = new GlideRecord('sys_user');
			userRecords.orderByDesc('name');
			userRecords.addEncodedQuery('nameSTARTSWITHs');
			userRecords.setLimit(5);
			userRecords.query();
			var memberDetails;
			while(userRecords.next())
			{
				memberDetails = {};
				$sp.getRecordDisplayValues(memberDetails, userRecords, 'sys_id,name');
				data.memberList.push(memberDetails);
			}
	}
	getSplitUsers();
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-06-04 13:31:36</sys_created_on>
        <sys_id>7cc4681a7fe60210d94a0cd10d86654b</sys_id>
        <sys_mod_count>217</sys_mod_count>
        <sys_name>Add expense</sys_name>
        <sys_package display_value="Splitwise" source="sn_splitwise">a8747a317f220210d94a0cd10d86659d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Splitwise">a8747a317f220210d94a0cd10d86659d</sys_scope>
        <sys_update_name>sp_widget_7cc4681a7fe60210d94a0cd10d86654b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-06-10 19:10:49</sys_updated_on>
        <template><![CDATA[<div id="parentBody">
  <!-- your widget template -->
  <button id="addExpenseBtn" ng-click="c.onAddExpense()" ng-show="!c.showExpenseForm"
          class="btn btn-{{options.color}} m-b">
    Add New Expense
  </button>
  <div id="expenseForm" ng-if="c.showExpenseForm">
    <form>
      <table id="expenseTable">
        <tr>
          <td>
            <label>Group Name:</label>
          </td>
          <td>
            <input type="text" class="expenseInput" ng-model="c.expenseObj.groupName" disabled="true">
          </td>
        </tr>
        <tr>
          <td>
            <label for="expenseName">Expense Name:</label>
          </td>
          <td>
            <input type="text" id="expenseName" 
                   ng-model="c.expenseObj.expenseName" ng-change="c.checkInputValidity()"
                   class="expenseInput"><br>
          </td>
        </tr>
        <tr>
          <td>
            <label for="paidBy">Paid by:</label>
          </td>
          <td>
            <select ng-model="c.expenseObj.paidBy" class="expenseInput"
                    ng-options='member.sys_id as member.name for member in c.memberList'>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            <label for="amount">Amount:</label>
          </td>
          <td>
            <input type="number" id="amount"
                   ng-model="c.expenseObj.amount" 
                   ng-change="c.onAmountChanged()"
                   class="expenseInput"><br>
          </td>
        </tr>
      </table>
      <table id="splittingTable">
        <tr>
          <td>
            <input type="checkbox" id="splitEqual" 
                   ng-model="c.expenseObj.splitEqually" ng-change="c.onSplitEqualChanged()"
                   class="checkboxStyle" ng-disabled="c.areMembersEmpty()">
            <label for="splitEqual" id="splitEqualLabel" class="checkboxLabelStyle">Split equally</label>
          </td>
        </tr>
        <tr>
          <th>Member name</th>
          <th>Amount</th>
        </tr>
        <tr ng-repeat="x in c.data.memberList">
          <td>{{x.name}}</td>
          <td>
            <input type="number" 
                   ng-model="x.amount" 
                   ng-disabled="c.expenseObj.splitEqually"
                   ng-change="c.isSumValid()">
          </td>
        </tr>
      </table>

                       <font color="red" id="errorMsg">
        {{c.expenseObj.errorMsg}}
      </font>
      <br> 
      <input type="submit" ng-disabled="!c.areInputsValid">

      <button ng-click="c.onCancel()">
        Cancel
      </button>

    </form>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
