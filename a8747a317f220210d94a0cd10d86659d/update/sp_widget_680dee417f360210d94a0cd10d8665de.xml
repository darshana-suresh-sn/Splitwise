<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope, spModal) {
	/* widget controller */
	var c = this;
	c.group_name = "Vacation";
	c.data.expenses = [];

	c.onAddExpenseClick = function(){
		var shared = {};
		shared.group_id = c.data.group_id;
		shared.action = "createNew";
		spModal.open({
			title:'Group - '+$scope.data.group_name,
			widget:'add_expense',
			shared:shared,
			buttons:[]
		}).then(function(result){
			console.log(JSON.stringify(result));
			if(!result.success)
				alert("Something went wrong");
			if(result.primary)
			{
				$scope.server.get({
					group_id:$scope.data.group_id
				}).then(function(response){
					c.data.expenses = response.data.expenses;
				});
			}
		});
	}
	c.onExpenseClick = function(expenseItem){
				var shared = {};
		shared.selectedExpense = expenseItem;
		shared.group_id = c.data.group_id;
		shared.action = "openExisting";
		spModal.open({
			title:'Group - '+$scope.data.group_name,
			widget:'add_expense',
			//widgetInput:{selectedExpense:expenseItem},
			shared:shared,
			buttons:[]
		}).then(function(result){
				if(!result.success)
					alert("Something went wrong");
				if(result.primary)
					c.updateData();
		});
	};
	c.updateData = function(){
				c.server.get({
					group_id:c.data.group_id
				}).then(function(response){
					c.data.expenses = response.data.expenses;
				});
	}

	$rootScope.$on('$sp.list.click',function(e, response) {
		if(response && response.table=="sn_splitwise_group" &&
			 response.sys_id)
		{	
			c.data.group_id = response.sys_id;
			c.data.group_name = response.record.display_field.display_value;
			$scope.server.get({
				group_id:response.sys_id
			}).then(function(response){
				c.data.expenses = response.data.expenses;
			});
		}
	});
};]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>expense_table_view</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Expense table view</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	var getExpensesInGroup = function(group_id)
	{
		var gr = new GlideRecord('sn_splitwise_expense');
		gr.query('group_id',group_id);
		gr.orderByDesc('sys_created_on');
		gr.query();
		data.expenses = [];
		var res;
		while(gr.next())
			{
				res = {};
				//$sp.getRecordDisplayValues(res,gr,'sys_id,expense_name,paid_by,total_amount');
				res.sys_id = gr.sys_id.getValue();
				res.expense_name = gr.expense_name.getValue();
				res.paid_by = gr.paid_by.getDisplayValue();
				res.paid_by_id = gr.paid_by.getValue();
				res.total_amount = gr.total_amount.getValue();
				data.expenses.push(res);
			}
	}
	if(input && input.group_id)
		{
		getExpensesInGroup(input.group_id);
		}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-06-13 12:30:09</sys_created_on>
        <sys_id>680dee417f360210d94a0cd10d8665de</sys_id>
        <sys_mod_count>46</sys_mod_count>
        <sys_name>Expense table view</sys_name>
        <sys_package display_value="Splitwise" source="sn_splitwise">a8747a317f220210d94a0cd10d86659d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Splitwise">a8747a317f220210d94a0cd10d86659d</sys_scope>
        <sys_update_name>sp_widget_680dee417f360210d94a0cd10d8665de</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-06-13 14:41:32</sys_updated_on>
        <template><![CDATA[<div id="parentBody">
  <!-- your widget template -->
  <button id="addGroupBtn" ng-click="c.onAddExpenseClick()"
          class="btn btn-{{options.color}} m-b"
          ng-disabled="!data.group_id">
    Add New Expense
  </button>
</div>  
<div class="panel panel-{{options.color}} b" ng-class="{'data-table-high-contrast': accessibilityModeEnabled}">
    <div class="panel-heading form-inline" ng-hide="options.hide_header">
      <h2 class="panel-title" style="display:inline"><i ng-if="options.glyph" class="fa fa-{{options.glyph}} m-r"></i>${Expenses in group }{{data.group_name}}</h2>
      <div class="clearfix"></div>
    </div>
  
  
    <div class="panel-body">

      <div class="clearfix"></div>
      <div class="alert alert-info" ng-if="!data.group_id">
        ${Select a group to view its expenses}
      </div>
            <div class="alert alert-info" ng-if="data.group_id && !data.expenses.length">
        ${No expenses yet}
      </div>
<table class="table table-striped table-responsive" ng-if="data.expenses.length">
  <caption class="sr-only">Expenses in group {{c.data.group_name}}</caption>
  <thead>
    <tr>
      <th class="text-nowrap" cope="col" role="columnheader">
        <div class="th-title" tabindex="0">Name</div>
      </th>
            <th class="text-nowrap" cope="col" role="columnheader">
        <div class="th-title" tabindex="0">Paid by</div>
      </th>
            <th class="text-nowrap" cope="col" role="columnheader">
        <div class="th-title" tabindex="0">Amount int Rs.</div>
      </th>
    </tr>
  </thead>
  <tbody>
    <tr ng-repeat="item in c.data.expenses">
      <td ><a  href="javascript:void(0)" ng-click="c.onExpenseClick(item)">{{item.expense_name}}</a>
      </td>
      <td>{{item.paid_by}}
      </td>
      <td>
        {{item.total_amount}}
      </td>
    </tr>
  </tbody>
</table>
</div>
</div>]]></template>
    </sp_widget>
</record_update>
